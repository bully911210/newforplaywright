<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MMX Auto-Filler - Documentation</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --heading: #f0f6fc;
      --accent: #58a6ff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
      --purple: #bc8cff;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .container { max-width: 960px; margin: 0 auto; padding: 2rem 1rem; }
    h1 { color: var(--heading); font-size: 2.5rem; margin-bottom: 0.5rem; }
    h2 { color: var(--heading); font-size: 1.5rem; margin: 2rem 0 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    h3 { color: var(--accent); font-size: 1.1rem; margin: 1.5rem 0 0.5rem; }
    .subtitle { color: var(--text); font-size: 1.1rem; margin-bottom: 2rem; opacity: 0.8; }
    .badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 2rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 0.5rem;
    }
    .badge-green { background: rgba(63,185,80,0.15); color: var(--green); border: 1px solid rgba(63,185,80,0.4); }
    .badge-blue { background: rgba(88,166,255,0.15); color: var(--accent); border: 1px solid rgba(88,166,255,0.4); }
    .badge-purple { background: rgba(188,140,255,0.15); color: var(--purple); border: 1px solid rgba(188,140,255,0.4); }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1.5rem;
      margin: 1rem 0;
    }

    .flow {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin: 1.5rem 0;
    }
    .flow-step {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      position: relative;
    }
    .flow-step::before {
      content: '';
      position: absolute;
      left: 19px;
      top: 40px;
      bottom: -1px;
      width: 2px;
      background: var(--border);
    }
    .flow-step:last-child::before { display: none; }
    .flow-num {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      color: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
      z-index: 1;
    }
    .flow-num.success { background: var(--green); }
    .flow-num.error { background: var(--red); }
    .flow-content {
      flex: 1;
      padding-bottom: 1.5rem;
    }
    .flow-title { color: var(--heading); font-weight: 600; margin-bottom: 0.25rem; }
    .flow-desc { font-size: 0.9rem; opacity: 0.8; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.9rem;
    }
    th, td {
      text-align: left;
      padding: 0.6rem 0.8rem;
      border: 1px solid var(--border);
    }
    th { background: var(--card); color: var(--heading); font-weight: 600; }
    td { background: var(--bg); }

    code {
      background: rgba(110,118,129,0.2);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-family: 'SFMono-Regular', Consolas, monospace;
    }
    pre {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      overflow-x: auto;
      font-size: 0.85rem;
      margin: 1rem 0;
    }
    pre code { background: none; padding: 0; }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 1rem 0;
    }
    @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }

    .error-card {
      border-left: 3px solid var(--red);
    }
    .warn-card {
      border-left: 3px solid var(--yellow);
    }
    .success-card {
      border-left: 3px solid var(--green);
    }

    .arch-diagram {
      text-align: center;
      padding: 2rem 1rem;
    }
    .arch-box {
      display: inline-block;
      padding: 0.6rem 1.2rem;
      border: 2px solid var(--accent);
      border-radius: 8px;
      color: var(--heading);
      font-weight: 600;
      margin: 0.25rem;
    }
    .arch-arrow {
      display: block;
      color: var(--accent);
      font-size: 1.5rem;
      margin: 0.25rem 0;
    }
    footer {
      margin-top: 3rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MMX Auto-Filler</h1>
    <p class="subtitle">Automated NPC Donation Client Entry for MMX Systems</p>
    <div>
      <span class="badge badge-green">Auto-Polling</span>
      <span class="badge badge-blue">MCP Server</span>
      <span class="badge badge-purple">Playwright</span>
    </div>

    <h2>Overview</h2>
    <p>An MCP server that reads client data from a Google Sheet and automatically fills the MMX Systems insurance administration forms via Playwright browser automation. Features auto-polling to detect and process new rows as they're added.</p>

    <h2>Architecture</h2>
    <div class="arch-diagram">
      <div class="arch-box">Google Sheet</div>
      <span class="arch-arrow">&#8595;</span>
      <div class="arch-box">Polling Loop (30s)</div>
      <span class="arch-arrow">&#8595;</span>
      <div class="arch-box">MCP Server (Node.js)</div>
      <span class="arch-arrow">&#8595;</span>
      <div class="arch-box">Playwright (Chromium)</div>
      <span class="arch-arrow">&#8595;</span>
      <div class="arch-box">MMX Systems (ASP.NET)</div>
      <span class="arch-arrow">&#8595;</span>
      <div class="arch-box">Google Sheet (Status Update)</div>
    </div>

    <h2>Automation Flow</h2>
    <p>Each row is processed through these steps sequentially. All steps must succeed in order.</p>

    <div class="flow">
      <div class="flow-step">
        <div class="flow-num">1</div>
        <div class="flow-content">
          <div class="flow-title">Fetch Row Data</div>
          <div class="flow-desc">Read client data from the Google Sheet. Status is set to "Processing..."</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num">2</div>
        <div class="flow-content">
          <div class="flow-title">Login to MMX</div>
          <div class="flow-desc">Navigate to <code>mmxsystems.co.za/login.aspx</code>, enter credentials, verify contentframe loads.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num">3</div>
        <div class="flow-content">
          <div class="flow-title">Client Search &rarr; New Client</div>
          <div class="flow-desc">Select Domestic, pick "GW6 - CIV DOMESTIC DONATION NPC" product, click New Client button.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num">4</div>
        <div class="flow-content">
          <div class="flow-title">Fill Client Tab</div>
          <div class="flow-desc">Fill donor name, surname, ID number, phone, email, address, postal code, inception date. Set postal = residential.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num success">5</div>
        <div class="flow-content">
          <div class="flow-title">File Client Tab</div>
          <div class="flow-desc">Click <code>#btnSave</code> inside <code>#ifrmClient</code>. Dismiss any modal dialogs.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num">6</div>
        <div class="flow-content">
          <div class="flow-title">Fill Policy Info</div>
          <div class="flow-desc">Set NPC company (CIV01), payment frequency, inception date, auto-calculate expiry (2099) and review month.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num">7</div>
        <div class="flow-content">
          <div class="flow-title">Fill Bank Details</div>
          <div class="flow-desc">Set account holder, account number, branch code (auto-mapped from bank name), collection day, account type (CDV-safe).</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num success">8</div>
        <div class="flow-content">
          <div class="flow-title">File Policy Tab</div>
          <div class="flow-desc">Click <code>#btnSave</code> inside <code>#ifrmPolicy</code>. Dismiss CDV validation warnings.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num">9</div>
        <div class="flow-content">
          <div class="flow-title">Fill Cover Tab (Donation)</div>
          <div class="flow-desc">Click Donation row, open dialog, click Add Item, enter donation amount in <code>#txt11</code> and <code>#txt1</code> (readonly formula, set via JS). Click File.</div>
        </div>
      </div>
      <div class="flow-step">
        <div class="flow-num success">10</div>
        <div class="flow-content">
          <div class="flow-title">Update Sheet Status</div>
          <div class="flow-desc">Write "Uploaded" to Column A. Row is complete.</div>
        </div>
      </div>
    </div>

    <h2>Error States</h2>

    <div class="card error-card">
      <h3>CRITICAL INPUT Modal</h3>
      <p>Appears when Cover tab is opened before Client and Policy tabs are filed. The automation files tabs in the correct order to prevent this.</p>
    </div>

    <div class="card warn-card">
      <h3>CDV Validation ("Failed CDV for Capitec Bank")</h3>
      <p>The bank details CDV check digit validation may fail for certain account/bank combinations. The automation dismisses this warning and continues - the record is still saved.</p>
    </div>

    <div class="card error-card">
      <h3>Session Expired Modal</h3>
      <p>MMX session timeout triggers a modal in the contentframe. The automation detects this and re-logins before proceeding.</p>
    </div>

    <div class="card warn-card">
      <h3>NPC Code Search Modal (#modalSearch)</h3>
      <p>Tabbing out of the NPC company code field triggers a search overlay. The automation dismisses this modal before continuing to other fields.</p>
    </div>

    <div class="card warn-card">
      <h3>Payment Method Reset</h3>
      <p>The account type dropdown <code>#txt28</code> has an <code>onchange</code> handler that resets the value via CDV validation. The automation removes the handler via JavaScript before setting the value, so ASP.NET reads the DOM directly on submit.</p>
    </div>

    <div class="card error-card">
      <h3>Browser Lock / Stale Process</h3>
      <p>If Playwright crashes, a stale browser process may hold locks on the user-data directory. Kill with: <code>wmic process where "CommandLine like '%%ms-playwright%%'" call terminate</code></p>
    </div>

    <h2>MMX Site Structure</h2>
    <pre><code>login.aspx (main page - URL never changes after login!)
  &boxur; contentframe (frame name="contentframe")
        &boxur; ClientSearch.aspx &rarr; after New Client:
              Tabs: Client | Policy | Cover | Schedule | Confidential | Premium
              &boxvr; #ifrmClient (default) - Donor info form
              &boxvr; #ifrmPolicy
              &boxv;     Sub-tabs: Policy Info (#tabli0) | Bank Details (#tabli1)
              &boxur; #ifrmCover
                    After addItem: Screen.aspx with #txt11, #txt1</code></pre>

    <h2>Google Sheet Columns</h2>
    <table>
      <tr><th>Column</th><th>Field</th><th>Example</th></tr>
      <tr><td>A</td><td>Status</td><td>"Uploaded" / "FAILED at ..."</td></tr>
      <tr><td>B</td><td>Client Name</td><td>Franz</td></tr>
      <tr><td>C</td><td>Client Surname</td><td>Badenhorst</td></tr>
      <tr><td>D</td><td>ID Number</td><td>9112105080083</td></tr>
      <tr><td>E</td><td>Cellphone</td><td>0621779799</td></tr>
      <tr><td>F</td><td>Email</td><td>franz@example.co.za</td></tr>
      <tr><td>G</td><td>Address</td><td>150 Soutpansberg Road</td></tr>
      <tr><td>H</td><td>City</td><td>Pretoria</td></tr>
      <tr><td>I</td><td>Province</td><td>Gauteng</td></tr>
      <tr><td>J</td><td>Postal Code</td><td>0186</td></tr>
      <tr><td>K</td><td>Account Holder</td><td>FH Badenhorst</td></tr>
      <tr><td>L</td><td>Bank</td><td>Capitec</td></tr>
      <tr><td>M</td><td>Account Number</td><td>2185450235</td></tr>
      <tr><td>N</td><td>Account Type</td><td>Savings</td></tr>
      <tr><td>O</td><td>Contract Amount</td><td>50</td></tr>
      <tr><td>P</td><td>Payment Frequency</td><td>Monthly</td></tr>
      <tr><td>Q</td><td>Debit Order Date</td><td>15</td></tr>
      <tr><td>R</td><td>Date Sale Made</td><td>02/10/2026</td></tr>
      <tr><td>S</td><td>Agent</td><td>Franz Badenhorst</td></tr>
    </table>

    <h2>Bank Branch Codes</h2>
    <table>
      <tr><th>Bank</th><th>Branch Code</th></tr>
      <tr><td>Capitec</td><td>470010</td></tr>
      <tr><td>ABSA</td><td>632005</td></tr>
      <tr><td>FNB</td><td>250655</td></tr>
      <tr><td>Nedbank</td><td>198765</td></tr>
      <tr><td>Standard Bank</td><td>051001</td></tr>
      <tr><td>African Bank</td><td>430000</td></tr>
      <tr><td>Investec</td><td>580105</td></tr>
      <tr><td>TymeBank</td><td>678910</td></tr>
      <tr><td>Discovery Bank</td><td>679000</td></tr>
      <tr><td>Bidvest Bank</td><td>462005</td></tr>
    </table>

    <h2>MCP Tools (12)</h2>
    <div class="grid-2">
      <div class="card">
        <h3>Data Tools</h3>
        <p><code>fetch_client_data</code> - Fetch single row</p>
        <p><code>list_clients</code> - List all clients</p>
        <p><code>update_cell</code> - Write to any cell</p>
      </div>
      <div class="card">
        <h3>Automation Tools</h3>
        <p><code>login_mmx</code> - Login to MMX</p>
        <p><code>fill_client_search</code> - New Client</p>
        <p><code>fill_client_info</code> - Client tab</p>
        <p><code>fill_policy_info</code> - Policy Info</p>
        <p><code>fill_bank_details</code> - Bank Details</p>
        <p><code>file_submission</code> - File Policy</p>
        <p><code>fill_cover_tab</code> - Cover/Donation</p>
      </div>
      <div class="card">
        <h3>Orchestration Tools</h3>
        <p><code>process_row</code> - Full E2E for one row</p>
        <p><code>start_polling</code> - Auto-poll for new rows</p>
        <p><code>stop_polling</code> - Stop auto-polling</p>
      </div>
      <div class="card">
        <h3>Configuration</h3>
        <p><code>POLL_INTERVAL_MS</code> - Poll every N ms (default: 30000)</p>
        <p><code>AUTO_START_POLLING</code> - Auto-start on server launch</p>
        <p><code>HEADLESS</code> - Run without visible browser</p>
      </div>
    </div>

    <h2>Setup</h2>
    <pre><code># Clone
git clone https://github.com/bully911210/newforplaywright.git
cd newforplaywright

# Install
npm install
npx playwright install chromium

# Configure
cp .env.example .env
# Edit .env with your MMX credentials and Google Sheet URL

# Build
npm run build

# Run as MCP server (for Claude)
npm start

# Run standalone poller (for background service)
npm run poll</code></pre>

    <footer>
      MMX Auto-Filler &middot; Built with TypeScript, Playwright, and MCP SDK
    </footer>
  </div>
</body>
</html>
